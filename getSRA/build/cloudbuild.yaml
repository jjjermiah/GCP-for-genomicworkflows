# Copyright 2021 Google LLC
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#      http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# Pull the container image (for --cache-from to compare)
# steps:
# - name: 'gcr.io/cloud-builders/docker'
#   entrypoint: 'bash'
#   args: ['-c', 'docker pull ${_DEPLOY_REGION}-docker.pkg.dev/orcestra-388613/bhklab-docker-repo/${_IMAGE_NAME}:latest || exit 0']

# - name: 'gcr.io/cloud-builders/docker'
#   args:
#     - 'build'
#     - '--network'
#     - 'cloudbuild'
#     - '-t'
#     - '${_DEPLOY_REGION}-docker.pkg.dev/orcestra-388613/bhklab-docker-repo/${_IMAGE_NAME}:latest'
#     - '.'
#     # - '--cache-from'  # Add this line to enable build caching
#     # - '${_DEPLOY_REGION}-docker.pkg.dev/orcestra-388613/bhklab-docker-repo/${_IMAGE_NAME}:latest'  # Specify the image to use as cache source

#   - id: "Deploy to Cloud Run"
#     name: "gcr.io/cloud-builders/gcloud:latest"
#     args:
#       - run
#       - deploy
#       - ${_SERVICE_NAME}
#       - --region=${_DEPLOY_REGION}
#       - '--image'
#       - '${_DEPLOY_REGION}-docker.pkg.dev/orcestra-388613/bhklab-docker-repo/downloadsra:latest'
#       - --execution-environment=gen2
#       - --update-env-vars=BUCKET=$BUCKET_NAME
#       - --allow-unauthenticated
# # Push the container image to Container Registry
# - name: 'gcr.io/cloud-builders/docker'
#   args: ['push', '${_DEPLOY_REGION}-docker.pkg.dev/orcestra-388613/bhklab-docker-repo/${_IMAGE_NAME}:latest']

# substitutions:
#   _SERVICE_NAME: filesystem
#   _DEPLOY_REGION: us-central1
#   _BUCKET_NAME: 'orcestra-testcloudrun'
#   _SERVICE_ACCOUNT: 'orcestra@orcestra-388613.iam.gserviceaccount.com'
steps:
- name: "gcr.io/cloud-builders/gcloud:latest"
  args:
    - run
    - deploy
    - build20
    - --source
    - .
    - --execution-environment
    - gen2
    - --region
    - us-central1
    - --allow-unauthenticated
    - --service-account
    - orcestra@orcestra-388613.iam.gserviceaccount.com
    - --update-env-vars
    - BUCKET=orcestra-testcloudrun
# - name: 'gcr.io/cloud-builders/docker'
#   args: 
#     - build
#     - --network 
#     - cloudbuild 
#     - --no-cache 
#     - -t 
#     - us-central1-docker.pkg.dev/orcestra-388613/cloud-run-source-deploy/build10 
#     - .